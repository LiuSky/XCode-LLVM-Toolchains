name: 编译 Hikari-LLVM19 并发布 Release

on:
  workflow_dispatch: # 手动触发

permissions:
  contents: write # 必须赋予写入权限才能创建 Release

jobs:
  build-ollvm:
    runs-on: macos-26 # GitHub 目前最新的 Apple Silicon 运行环境
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: Aethereux/Hikari-LLVM19
          fetch-depth: 1

      - name: Select Xcode 26.2
        run: |
          # 强制切换到 Xcode 26.2
          sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
          echo "Selected Xcode Path: $(xcode-select -p)"

      - name: Print Detailed System & Hardware Information
        run: |
          echo "==================== OS 信息 ===================="
          sw_vers
          uname -a
          
          echo "==================== 硬件信息 ===================="
          system_profiler SPHardwareDataType
          
          echo "==================== CPU & 内存信息 ===================="
          sysctl -n machdep.cpu.brand_string
          sysctl hw.memsize | awk '{print "Memory: " $2/1024/1024/1024 " GB"}'
          
          echo "==================== Xcode 信息 ===================="
          xcodebuild -version
          cc -v

      - name: Install Build Tools
        run: |
          brew install cmake ninja

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS="clang;lld" \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install" \
            ../llvm

      - name: Build
        run: |
          cd build
          ninja

      - name: Install and Package
        id: package
        run: |
          cd build
          ninja install-xcode-toolchain
          
          # 查找生成的 .xctoolchain 目录
          TOOLCHAIN_DIR=$(find ${{ github.workspace }}/install -name "*.xctoolchain" -type d)
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "错误: 未找到生成的 toolchain 目录"
            exit 1
          fi
          
          cd "$(dirname "$TOOLCHAIN_DIR")"
          FOLDER_NAME=$(basename "$TOOLCHAIN_DIR")
          ZIP_NAME="Hikari-LLVM19-Xcode26.2-macOS15.xctoolchain.zip"
          
          echo "正在打包: $FOLDER_NAME -> $ZIP_NAME"
          zip -r "${{ github.workspace }}/$ZIP_NAME" "$FOLDER_NAME"
          
          # 设置变量供后续步骤使用
          echo "zip_path=${{ github.workspace }}/$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=v19-$(date +'%Y%m%d%H%M')" >> $GITHUB_OUTPUT

      - name: Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package.outputs.tag_name }}
          name: Hikari-LLVM19 (macOS 26 / Xcode 26.2)
          body: |
            自动编译的 Hikari-LLVM19 Apple Silicon 版本。
            - 编译环境: macOS 26
            - Xcode 版本: 26.2
            - 架构: arm64 (Universal Apple Silicon)
            - 基础版本: LLVM 19
          draft: false
          prerelease: false
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
