name: 编译 Hikari-LLVM19 工具链 (Apple Silicon 版)

on:
  workflow_dispatch:
    inputs:
      version:
        description: '请输入发布版本号 (例如: 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write 

jobs:
  build-ollvm:
    runs-on: macos-26 
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: Aethereux/Hikari-LLVM19
          fetch-depth: 1

      - name: Select Xcode 26.2
        run: |
          echo "正在尝试切换到 Xcode 26.2..."
          # 注意：如果路径不存在会报错。在当前 GitHub 环境中实际为 /Applications/Xcode_16.2.app
          # 下面这行按你要求写成 26.2
          if [ -d "/Applications/Xcode_26.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
          else
            echo "警告: 未找到 Xcode 26.2，将显示当前默认 Xcode 版本"
          fi
          echo "当前使用的 Xcode 路径: $(xcode-select -p)"

      - name: Print Detailed System & Hardware Information
        run: |
          echo "==================== [1] 操作系统信息 (OS) ===================="
          sw_vers
          uname -a
          
          echo "==================== [2] 硬件详细信息 (Hardware) ===================="
          system_profiler SPHardwareDataType
          
          echo "==================== [3] CPU & 内存信息 ===================="
          echo "CPU 型号:"
          sysctl -n machdep.cpu.brand_string
          echo "核心数:"
          sysctl -n hw.ncpu
          echo "内存大小:"
          sysctl hw.memsize | awk '{print $2/1024/1024/1024 " GB"}'
          
          echo "==================== [4] Xcode & 编译器信息 ===================="
          xcodebuild -version
          cc -v
          
          echo "==================== [5] 当前架构 (Arch) ===================="
          arch

      - name: Install Build Tools
        run: |
          brew install cmake ninja

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS="clang;lld" \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install" \
            ../llvm

      - name: Build
        run: |
          cd build
          ninja

      - name: Install and Package
        id: package
        run: |
          cd build
          ninja install-xcode-toolchain
          
          # 查找生成的 .xctoolchain 目录
          TOOLCHAIN_DIR=$(find ${{ github.workspace }}/install -name "*.xctoolchain" -type d)
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "错误: 未找到生成的 toolchain 目录"
            exit 1
          fi
          
          cd "$(dirname "$TOOLCHAIN_DIR")"
          FOLDER_NAME=$(basename "$TOOLCHAIN_DIR")
          # 文件名包含你输入的版本号
          ZIP_NAME="Hikari-LLVM19-${{ github.event.inputs.version }}-Xcode26.2-macOS26.xctoolchain.zip"
          
          echo "正在打包: $FOLDER_NAME -> $ZIP_NAME"
          zip -r "${{ github.workspace }}/$ZIP_NAME" "$FOLDER_NAME"
          
          # 设置变量供后续步骤使用
          echo "zip_path=${{ github.workspace }}/$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release and Upload Asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package.outputs.tag_name }}
          name: Hikari-LLVM19 Release ${{ github.event.inputs.version }}
          body: |
            ## 编译信息
            - **版本**: ${{ github.event.inputs.version }}
            - **编译平台**: macOS 26 (Apple Silicon)
            - **Xcode 版本**: 26.2
            - **LLVM 核心**: 19.x
            - **构建时间**: $(date)
            
            此工具链专门为 Apple Silicon (M1/M2/M3/M4) 架构优化。
          draft: false
          prerelease: false
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
