name: ç¼–è¯‘ Hikari-LLVM19 å·¥å…·é“¾ (Apple Silicon ç‰ˆ)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'è¯·è¾“å…¥å‘å¸ƒç‰ˆæœ¬å· (ä¾‹å¦‚: 1.0.0)'
        required: true
        default: '1.0.0'

permissions:
  contents: write 

jobs:
  build-ollvm:
    runs-on: macos-26 
    
    steps:
      - name: æ­¥éª¤ 1ï¼šæ£€å‡ºæºä»£ç 
        uses: actions/checkout@v4
        with:
          repository: Aethereux/Hikari-LLVM19
          fetch-depth: 1

      - name: æ­¥éª¤ 2ï¼šåˆ‡æ¢ Xcode ç‰ˆæœ¬ (26.2)
        run: |
          echo "æ­£åœ¨å°è¯•åˆ‡æ¢åˆ° Xcode 26.2..."
          if [ -d "/Applications/Xcode_26.2.app" ]; then
            sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
          else
            echo "è­¦å‘Šï¼šç³»ç»Ÿæœªå‘ç° /Applications/Xcode_26.2.appï¼Œå°†ä½¿ç”¨ç³»ç»Ÿé»˜è®¤ç‰ˆæœ¬ã€‚"
          fi
          echo "å½“å‰ä½¿ç”¨çš„ Xcode è·¯å¾„: $(xcode-select -p)"

      - name: æ­¥éª¤ 3ï¼šæ‰“å°è¯¦ç»†ç³»ç»Ÿä¸ç¡¬ä»¶ä¿¡æ¯
        run: |
          echo "==================== [1] æ“ä½œç³»ç»Ÿä¿¡æ¯ (OS) ===================="
          sw_vers
          uname -a
          
          echo "==================== [2] ç¡¬ä»¶è¯¦ç»†ä¿¡æ¯ (Hardware) ===================="
          system_profiler SPHardwareDataType
          
          echo "==================== [3] CPU ä¸ å†…å­˜ä¿¡æ¯ ===================="
          echo "CPU å‹å·:"
          sysctl -n machdep.cpu.brand_string
          echo "æ ¸å¿ƒæ•°é‡:"
          sysctl -n hw.ncpu
          echo "ç‰©ç†å†…å­˜:"
          sysctl hw.memsize | awk '{print $2/1024/1024/1024 " GB"}'
          
          echo "==================== [4] Xcode ä¸ ç¼–è¯‘å™¨ç‰ˆæœ¬ ===================="
          xcodebuild -version
          cc -v
          
          echo "==================== [5] å½“å‰è¿è¡Œæ¶æ„ ===================="
          arch

      - name: æ­¥éª¤ 4ï¼šå®‰è£…æ„å»ºå·¥å…· (CMake/Ninja)
        run: |
          echo "æ­£åœ¨é€šè¿‡ Homebrew å®‰è£…æ„å»ºå·¥å…·..."
          brew install cmake ninja

      - name: æ­¥éª¤ 5ï¼šé…ç½® CMake å‚æ•°
        run: |
          echo "æ­£åœ¨åˆ›å»ºæ„å»ºç›®å½•å¹¶é…ç½® CMake..."
          mkdir build
          cd build
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS="clang;lld" \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install" \
            ../llvm

      - name: æ­¥éª¤ 6ï¼šå¼€å§‹ç¼–è¯‘å·¥å…·é“¾ (æ­¤è¿‡ç¨‹è¾ƒé•¿)
        run: |
          echo "å¼€å§‹è¿è¡Œ Ninja è¿›è¡Œç¼–è¯‘..."
          cd build
          ninja

      - name: æ­¥éª¤ 7ï¼šæ‰§è¡Œå®‰è£…ä¸æ‰“åŒ…
        id: package
        run: |
          echo "æ­£åœ¨ç”Ÿæˆ Xcode Toolchain ç»“æ„..."
          cd build
          ninja install-xcode-toolchain
          
          # å®šä½ç”Ÿæˆçš„ .xctoolchain ç›®å½•
          TOOLCHAIN_DIR=$(find ${{ github.workspace }}/install -name "*.xctoolchain" -type d)
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "é”™è¯¯ï¼šæœªèƒ½æ‰¾åˆ°ç¼–è¯‘ç”Ÿæˆçš„ toolchain æ–‡ä»¶å¤¹ï¼Œè¯·æ£€æŸ¥ç¼–è¯‘æ—¥å¿—ã€‚"
            exit 1
          fi
          
          cd "$(dirname "$TOOLCHAIN_DIR")"
          FOLDER_NAME=$(basename "$TOOLCHAIN_DIR")
          # ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ç‰ˆæœ¬å·å‘½åå‹ç¼©åŒ…
          ZIP_NAME="Hikari-LLVM19-${{ github.event.inputs.version }}-Xcode26.2-macOS26.xctoolchain.zip"
          
          echo "æ­£åœ¨æ‰“åŒ…å·¥å…·é“¾ï¼š$FOLDER_NAME -> $ZIP_NAME"
          zip -r "${{ github.workspace }}/$ZIP_NAME" "$FOLDER_NAME"
          
          # è¾“å‡ºç»“æœä¾›åç»­ Release æ­¥éª¤ä½¿ç”¨
          echo "zip_path=${{ github.workspace }}/$ZIP_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT

      - name: æ­¥éª¤ 8ï¼šå‘å¸ƒ GitHub Release å¹¶ä¸Šä¼ æ–‡ä»¶
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.package.outputs.tag_name }}
          name: "Hikari-LLVM19 è‡ªåŠ¨å‘å¸ƒ - ç‰ˆæœ¬å· ${{ github.event.inputs.version }}"
          body: |
            ## ğŸ›  ç¼–è¯‘ç¯å¢ƒæŠ¥å‘Š
            - **è½¯ä»¶ç‰ˆæœ¬**: ${{ github.event.inputs.version }}
            - **ç¼–è¯‘å¹³å°**: macOS 26 (Apple Silicon å®ä¾‹)
            - **Xcode ç‰ˆæœ¬**: 26.2
            - **ç¼–è¯‘å™¨å†…æ ¸**: LLVM 19
            - **ç›®æ ‡æ¶æ„**: arm64 (Universal)
            - **æ„å»ºçŠ¶æ€**: æˆåŠŸ
            
            æ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå¹¶å‘å¸ƒã€‚
          draft: false
          prerelease: false
          files: ${{ steps.package.outputs.zip_path }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
