name: 编译 Hikari-LLVM15 工具链 (Apple Silicon 版) (Xcode 26.2 + macOS 15)

on:
  workflow_dispatch: # 手动触发构建

jobs:
  build-ollvm:
    # 使用 macOS 15 (Sequoia) 运行环境
    runs-on: macos-15
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          repository: Aethereux/Hikari-LLVM19
          fetch-depth: 1

      - name: Select Xcode 26.2
        run: |
          # 查找 Xcode 26.2 的路径并切换
          # 在 GitHub macos-15 镜像中，Xcode 26.2 的路径通常如下：
          sudo xcode-select -s /Applications/Xcode_26.2.app/Contents/Developer
          xcodebuild -version

      - name: Install Build Tools
        run: |
          brew install cmake ninja

      - name: Configure CMake
        run: |
          mkdir build
          cd build
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS="clang;lld" \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="${{ github.workspace }}/install" \
            ../llvm

      - name: Build Hikari LLVM
        run: |
          cd build
          ninja

      - name: Install Toolchain
        run: |
          cd build
          # 安装到指定的 install 目录
          ninja install-xcode-toolchain
          
          # 定位生成的 .xctoolchain 文件夹
          # 路径通常是: install/lib/Toolchains/LLVM19.0.0git.xctoolchain
          TOOLCHAIN_DIR=$(find ${{ github.workspace }}/install -name "*.xctoolchain" -type d)
          echo "FOUND_TOOLCHAIN=$TOOLCHAIN_DIR" >> $GITHUB_ENV
          echo "Toolchain found at: $TOOLCHAIN_DIR"

      - name: Package Toolchain
        run: |
          cd "${{ env.FOUND_TOOLCHAIN }}/.."
          FOLDER_NAME=$(basename "${{ env.FOUND_TOOLCHAIN }}")
          # 压缩成 zip，方便下载
          zip -r "${{ github.workspace }}/Hikari-LLVM19-Xcode26.2-macOS15-arm64.xctoolchain.zip" "$FOLDER_NAME"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Hikari-LLVM19-Xcode26.2-arm64
          path: Hikari-LLVM19-Xcode26.2-macOS15-arm64.xctoolchain.zip
          retention-days: 7
