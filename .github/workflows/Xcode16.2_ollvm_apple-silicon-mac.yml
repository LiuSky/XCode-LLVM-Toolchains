name: ç¼–è¯‘ Hikari-LLVM15 å·¥å…·é“¾ (Apple Silicon ç‰ˆ)

on:
  # æ‰‹åŠ¨è§¦å‘ç¼–è¯‘
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'å‘å¸ƒåˆ° Release çš„ç‰ˆæœ¬å· (å¦‚ v1.0-M1)'
        required: true
        default: 'v1.0-M1'

# èµ‹äºˆ Action å†™å…¥ Release çš„æƒé™
permissions:
  contents: write

jobs:
  build_toolchain:
    # macos-14 æ˜¯æ ‡å‡†çš„ Apple Silicon (M1) è¿è¡Œå™¨
    runs-on: macos-14

    steps:
      # --- æ­¥éª¤ 1ï¼šç¡®è®¤å½“å‰ç¡¬ä»¶æ¶æ„ (ç¡®ä¿æ˜¯ M èŠ¯ç‰‡) ---
      - name: 1. éªŒè¯ç¡¬ä»¶æ¶æ„
        run: |
          echo "--- ç¡¬ä»¶å¹³å°ä¿¡æ¯ ---"
          uname -a
          echo "--- å¤„ç†å™¨æ¶æ„ ---"
          uname -m
          sysctl -n machdep.cpu.brand_string

      # --- æ­¥éª¤ 2ï¼šåŸºç¡€ç¯å¢ƒè®¾ç½® ---
      - name: 2. è®¾ç½® Git ç¼“å†²åŒº
        run: git config --global http.postBuffer 524288000

      - name: 3. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: brew install ninja cmake

      # --- æ­¥éª¤ 4ï¼šå¼ºåˆ¶åˆ‡æ¢ Xcode ç‰ˆæœ¬åˆ° 16.2 ---
      - name: 4. åˆ‡æ¢ Xcode ç‰ˆæœ¬
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          xcodebuild -version

      # --- æ­¥éª¤ 5ï¼šé€’å½’å…‹éš† Hikari-LLVM15 æºç  ---
      - name: 5. å…‹éš†æºç  (Recursive)
        run: |
          git clone --recursive -b apple-arm64e-upstream-next https://github.com/LiuSky/Hikari-LLVM15.git

      # --- æ­¥éª¤ 6ï¼šæ‰§è¡Œ CMake é…ç½® (æ¯æ¬¡éƒ½é‡æ–°é…ç½®) ---
      - name: 6. æ‰§è¡Œ CMake é…ç½®
        run: |
          mkdir -p Build
          cd Build
          ABS_INSTALL_DIR=$(pwd)/install
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS=clang \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="$ABS_INSTALL_DIR" \
            ../Hikari-LLVM15/llvm

      # --- æ­¥éª¤ 7ï¼šå¼€å§‹ Ninja ç¼–è¯‘ (æ¯æ¬¡éƒ½å®Œæ•´ç¼–è¯‘) ---
      - name: 7. å¼€å§‹ Ninja ç¼–è¯‘
        run: |
          cd Build
          ninja

      # --- æ­¥éª¤ 8ï¼šç”Ÿæˆ Xcode å·¥å…·é“¾ç»“æ„ ---
      - name: 8. å®‰è£…å¹¶ç”Ÿæˆ Xcode å·¥å…·é“¾
        run: |
          cd Build
          # æ‰§è¡Œå®‰è£…ï¼Œå°†ç¼–è¯‘å‡ºçš„æ–‡ä»¶æ”¾å…¥ install ç›®å½•
          ninja install
          # ç”Ÿæˆ .xctoolchain æ–‡ä»¶å¤¹
          ninja install-xcode-toolchain

      # --- æ­¥éª¤ 9ï¼šæ‰“åŒ…å·¥å…·é“¾æˆå“ ---
      - name: 9. æ‰“åŒ…å·¥å…·é“¾æˆå“
        run: |
          # å¯»æ‰¾ç”Ÿæˆçš„ .xctoolchain æ–‡ä»¶å¤¹
          TOOLCHAIN_PATH=$(find Build/install -name "*.xctoolchain" -type d | head -n 1)
          
          if [ -z "$TOOLCHAIN_PATH" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ç”Ÿæˆçš„å·¥å…·é“¾æ–‡ä»¶å¤¹"
            find Build/install -maxdepth 4
            exit 1
          fi
          
          BASE_DIR=$(dirname "$TOOLCHAIN_PATH")
          FOLDER_NAME=$(basename "$TOOLCHAIN_PATH")
          
          echo "âœ… æ‰¾åˆ°å·¥å…·é“¾: $FOLDER_NAME åœ¨ $BASE_DIR"
          
          # è¿›å…¥æ‰€åœ¨ç›®å½•å¹¶æ‰“åŒ…
          cd "$BASE_DIR"
          tar -czvf ../../../Hikari-LLVM15-Xcode16.tar.gz "$FOLDER_NAME"
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ"

      # --- æ­¥éª¤ 10ï¼šåˆ›å»º Release å¹¶ä¸Šä¼ æˆå“ ---
      - name: 10. ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          files: ./Hikari-LLVM15-Xcode16.tar.gz
          body: |
            Hikari-LLVM15 åŸå§‹ç¼–è¯‘æˆå“ (Apple Silicon / Xcode 16)
            - ç¡¬ä»¶å¹³å°: GitHub Actions macos-14 (Apple M1 è¿è¡Œå™¨)
            - ç¼–è¯‘ç¯å¢ƒ: Xcode 16.2
            - è¯´æ˜: æ¯æ¬¡è¿è¡Œå‡é€šè¿‡äº‘ç«¯å…¨æ–°ç¼–è¯‘ç”Ÿæˆã€‚
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
