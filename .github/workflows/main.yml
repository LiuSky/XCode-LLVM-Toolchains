name: 编译 Hikari-LLVM15 工具链 (Xcode 16)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: '发布到 Release 的版本号 (如 v1.0)'
        required: true
        default: 'v1.0'

permissions:
  contents: write

jobs:
  build_toolchain:
    runs-on: macos-14 # 使用 macOS 14 运行器

    steps:
      - name: 1. 设置 Git 缓冲区
        run: git config --global http.postBuffer 524288000

      - name: 2. 安装编译依赖
        run: brew install ninja cmake

      # --- 关键：切换到 Xcode 16.2 ---
      - name: 3. 切换 Xcode 版本到 16.2
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          xcodebuild -version

      - name: 4. 克隆源码并重定向子模块地址
        run: |
          git clone -b apple-arm64e-upstream-next https://github.com/LiuSky/Hikari-LLVM15.git
          cd Hikari-LLVM15

      - name: 5. 执行 CMake 配置 (使用绝对路径)
        run: |
          mkdir Build
          cd Build
          # 获取当前绝对路径作为安装前缀
          INSTALL_PREFIX=$(pwd)/install
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS=clang \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="$INSTALL_PREFIX" \
            ../Hikari-LLVM15/llvm

      - name: 6. 开始 Ninja 编译
        run: |
          cd Build
          ninja

      # --- 关键：同时执行 install 和 install-xcode-toolchain ---
      - name: 7. 安装并生成工具链结构
        run: |
          cd Build
          # 先进行标准安装，确保 lib 目录生成
          ninja install
          # 再生成工具链包
          ninja install-xcode-toolchain

      - name: 8. 修复 compiler-rt (强化路径探测)
        run: |
          # 1. 定位系统 Xcode 16.2 的库路径
          SYS_LIB_PATH=$(ls -d /Applications/Xcode_16.2.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/*/lib/darwin | head -n 1)
          echo "系统编译器库源路径: $SYS_LIB_PATH"
          
          # 2. 深度搜索生成的 .xctoolchain 文件夹
          # 不再限制在 Build/install，而是在整个 Build 目录下找
          TOOLCHAIN_DIR=$(find Build -name "*.xctoolchain" -type d | head -n 1)
          echo "工具链实际位置: $TOOLCHAIN_DIR"
          
          if [ -z "$TOOLCHAIN_DIR" ]; then
            echo "❌ 错误：未找到生成的 .xctoolchain 文件夹"
            exit 1
          fi
          
          # 3. 搜索工具链内部存放 clang 库的 lib 目录
          TARGET_CLANG_LIB_DIR=$(find "$TOOLCHAIN_DIR" -name "lib" -type d | grep "clang" | head -n 1)
          echo "目标修复路径: $TARGET_CLANG_LIB_DIR"
          
          if [ -n "$TARGET_CLANG_LIB_DIR" ]; then
            mkdir -p "$TARGET_CLANG_LIB_DIR/darwin"
            cp -R "$SYS_LIB_PATH/" "$TARGET_CLANG_LIB_DIR/darwin/"
            echo "✅ compiler-rt 修复成功"
          else
            echo "❌ 错误：无法定位工具链内部的 Clang lib 目录"
            # 打印目录结构辅助调试
            find Build -maxdepth 5
            exit 1
          fi

      - name: 9. 打包工具链 (Hikari-LLVM15-Xcode16.tar.gz)
        run: |
          # 找到工具链所在目录并打包
          TOOLCHAIN_PATH=$(find Build -name "*.xctoolchain" -type d | head -n 1)
          TOOLCHAIN_DIRNAME=$(dirname "$TOOLCHAIN_PATH")
          TOOLCHAIN_BASENAME=$(basename "$TOOLCHAIN_PATH")
          
          echo "打包路径: $TOOLCHAIN_DIRNAME / $TOOLCHAIN_BASENAME"
          cd "$TOOLCHAIN_DIRNAME"
          tar -czvf ../../Hikari-LLVM15-Xcode16.tar.gz "$TOOLCHAIN_BASENAME"

      - name: 10. 上传到 Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          files: Hikari-LLVM15-Xcode16.tar.gz
          body: |
            ### Hikari LLVM 15 预编译工具链 (Xcode 16)
            - **适配**: Xcode 16.2
            - **修复**: 已补全 compiler-rt (darwin libs)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
