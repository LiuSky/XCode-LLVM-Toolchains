name: ç¼–è¯‘ Hikari-LLVM15 å·¥å…·é“¾ (Xcode 16)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'å‘å¸ƒåˆ° Release çš„ç‰ˆæœ¬å· (å¦‚ v1.0)'
        required: true
        default: 'v1.0'

permissions:
  contents: write

jobs:
  build_toolchain:
    runs-on: macos-14

    steps:
      - name: 1. è®¾ç½® Git ç¼“å†²åŒº
        run: git config --global http.postBuffer 524288000

      - name: 2. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: brew install ninja cmake

      - name: 3. åˆ‡æ¢ Xcode ç‰ˆæœ¬
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          xcodebuild -version

      - name: 4. å…‹éš†æºç  (Recursive)
        run: |
          git clone --recursive -b apple-arm64e-upstream-next https://github.com/LiuSky/Hikari-LLVM15.git

      # --- æ ¸å¿ƒæ”¹è¿›ï¼šç¼“å­˜ç¼–è¯‘ç›®å½• ---
      # ç¬¬ä¸€æ¬¡è¿è¡Œä¼šå¾ˆæ…¢ï¼Œä½†åªè¦æˆåŠŸç¼–è¯‘è¿‡ä¸€æ¬¡ï¼Œä»¥ååªè¦æºç ä¸æ”¹ï¼Œè¿™æ­¥å°±ä¼šç§’è¿‡
      - name: 5. ç¼“å­˜ç¼–è¯‘ç»“æœ (Cache)
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: Build
          # key åªè¦ä¸å˜ï¼Œå°±ä¼šä¸€ç›´ä½¿ç”¨åŒä¸€ä¸ªç¼“å­˜
          key: ${{ runner.os }}-llvm-build-v1

      - name: 6. æ‰§è¡Œ CMake é…ç½® (ä»…åœ¨æ— ç¼“å­˜æ—¶æ‰§è¡Œ)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          mkdir -p Build
          cd Build
          ABS_INSTALL_DIR=$(pwd)/install
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS=clang \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="$ABS_INSTALL_DIR" \
            ../Hikari-LLVM15/llvm

      - name: 7. å¼€å§‹ Ninja ç¼–è¯‘ (ä»…åœ¨æ— ç¼“å­˜æ—¶æ‰§è¡Œ)
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cd Build
          ninja

      - name: 8. å®‰è£…å¹¶ç”Ÿæˆ Xcode å·¥å…·é“¾ç»“æ„
        run: |
          cd Build
          # è¿™ä¸€æ­¥å¾ˆå¿«ï¼Œä¸ç¼“å­˜ï¼Œæ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆ install ç›®å½•
          ninja install
          ninja install-xcode-toolchain

      # --- å…³é”®ä¿®æ”¹ï¼šä¿®å¤ compiler-rt (æ›´å¼ºå¤§çš„è·¯å¾„å®šä½) ---
      - name: 9. ä¿®å¤å¹¶å¤åˆ¶ compiler-rt åº“
        run: |
          # 1. ç³»ç»Ÿåº“è·¯å¾„
          SYS_LIB_PATH=$(ls -d /Applications/Xcode_16.2.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/*/lib/darwin | head -n 1)
          echo "âœ… ç³»ç»Ÿç¼–è¯‘å™¨åº“æºè·¯å¾„: $SYS_LIB_PATH"
          
          # 2. å®šä½ç”Ÿæˆçš„å·¥å…·é“¾æ ¹ç›®å½•
          TARGET_TOOLCHAIN_DIR=$(find Build -name "*.xctoolchain" -type d | head -n 1)
          echo "âœ… å·¥å…·é“¾æ ¹ç›®å½•: $TARGET_TOOLCHAIN_DIR"
          
          if [ -z "$TARGET_TOOLCHAIN_DIR" ]; then
            echo "âŒ æ— æ³•æ‰¾åˆ° .xctoolchain æ–‡ä»¶å¤¹"
            exit 1
          fi

          # 3. æš´åŠ›å¯»æ‰¾ clang ä¸‹çš„ lib æ–‡ä»¶å¤¹ (ä¸ç®¡ç‰ˆæœ¬å·æ˜¯ 15 è¿˜æ˜¯ 19)
          # æˆ‘ä»¬å¯»æ‰¾ä»»ä½•åŒ…å« 'usr/lib/clang' ä¸”ç»“å°¾æ˜¯ 'lib' çš„ç›®å½•
          TARGET_CLANG_LIB_DIR=$(find "$TARGET_TOOLCHAIN_DIR" -type d -path "*/usr/lib/clang/*/lib" | head -n 1)
          
          if [ -z "$TARGET_CLANG_LIB_DIR" ]; then
             echo "âš ï¸ æœªèƒ½é€šè¿‡å¸¸è§„è·¯å¾„æ‰¾åˆ°ï¼Œå°è¯•å¯»æ‰¾ä»»ä½•åä¸º lib çš„ç›®å½•..."
             TARGET_CLANG_LIB_DIR=$(find "$TARGET_TOOLCHAIN_DIR" -name "lib" -type d | grep "clang" | head -n 1)
          fi
          
          echo "âœ… æœ€ç»ˆç¡®å®šçš„ç›®æ ‡ä¿®å¤è·¯å¾„: $TARGET_CLANG_LIB_DIR"
          
          # 4. æ‰§è¡Œå¤åˆ¶
          if [ -n "$TARGET_CLANG_LIB_DIR" ]; then
            mkdir -p "$TARGET_CLANG_LIB_DIR/darwin"
            cp -R "$SYS_LIB_PATH/" "$TARGET_CLANG_LIB_DIR/darwin/"
            echo "ğŸ‰ compiler-rt ä¿®å¤æˆåŠŸï¼"
          else
            echo "âŒ ä»ç„¶æ— æ³•å®šä½å·¥å…·é“¾å†…éƒ¨çš„ Clang lib ç›®å½•ã€‚"
            echo "--- ä»¥ä¸‹æ˜¯å·¥å…·é“¾å†…éƒ¨çš„æ‰€æœ‰ç›®å½•ç»“æ„ï¼Œè¯·æŸ¥çœ‹ ---"
            find "$TARGET_TOOLCHAIN_DIR" -maxdepth 8
            exit 1
          fi

      - name: 10. æ‰“åŒ…å¹¶ä¸Šä¼ 
        run: |
          FULL_PATH=$(find Build -name "*.xctoolchain" -type d | head -n 1)
          BASE_DIR=$(dirname "$FULL_PATH")
          FOLDER_NAME=$(basename "$FULL_PATH")
          cd "$BASE_DIR"
          tar -czvf ../../Hikari-LLVM15-Xcode16.tar.gz "$FOLDER_NAME"

      - name: 11. ä¸Šä¼ æˆå“åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          files: Hikari-LLVM15-Xcode16.tar.gz
          body: "é¢„ç¼–è¯‘å·¥å…·é“¾ (åŒ…å«ä¿®å¤åçš„ compiler-rt)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
