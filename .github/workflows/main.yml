name: ç¼–è¯‘ Hikari-LLVM15 å·¥å…·é“¾ (Xcode 16)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'å‘å¸ƒåˆ° Release çš„ç‰ˆæœ¬å· (å¦‚ v1.0)'
        required: true
        default: 'v1.0'

permissions:
  contents: write

jobs:
  build_toolchain:
    runs-on: macos-14

    steps:
      - name: 1. è®¾ç½® Git ç¼“å†²åŒº
        run: git config --global http.postBuffer 524288000

      - name: 2. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: brew install ninja cmake

      - name: 3. åˆ‡æ¢ Xcode ç‰ˆæœ¬
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          xcodebuild -version

      - name: 4. å…‹éš†æºç  (Recursive)
        run: |
          git clone --recursive -b apple-arm64e-upstream-next https://github.com/LiuSky/Hikari-LLVM15.git

      # --- ç¼“å­˜åŠ é€Ÿï¼šå¦‚æœç¼–è¯‘è¿‡ï¼Œä¸‹æ¬¡ç›´æ¥è·³è¿‡ 1 å°æ—¶ ---
      - name: 5. ç¼“å­˜ç¼–è¯‘ç»“æœ (Cache)
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: Build
          key: ${{ runner.os }}-llvm-build-v2 # æ›´æ”¹ key è§¦å‘é‡æ–°ç¼“å­˜

      - name: 6. æ‰§è¡Œ CMake é…ç½®
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          mkdir -p Build
          cd Build
          ABS_INSTALL_DIR=$(pwd)/install
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS=clang \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="$ABS_INSTALL_DIR" \
            ../Hikari-LLVM15/llvm

      - name: 7. å¼€å§‹ Ninja ç¼–è¯‘
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cd Build
          ninja

      - name: 8. ç”Ÿæˆ Xcode å·¥å…·é“¾ç»“æ„
        run: |
          cd Build
          ninja install
          ninja install-xcode-toolchain

      # --- é‡ç‚¹ï¼šæ ¹æ®ä½ æä¾›çš„æ—¥å¿—æ ‘è¿›è¡Œä¿®å¤ ---
      - name: 9. ä¿®å¤å¹¶å¤åˆ¶ compiler-rt åº“
        run: |
          # 1. ç³»ç»Ÿåº“æºè·¯å¾„ (Xcode 16.2)
          SYS_LIB_PATH=$(ls -d /Applications/Xcode_16.2.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/*/lib/darwin | head -n 1)
          echo "âœ… ç³»ç»Ÿæºè·¯å¾„: $SYS_LIB_PATH"
          
          # 2. å®šä½å·¥å…·é“¾æ ¹ç›®å½• (æ ¹æ®ä½ çš„æ—¥å¿—: Build/install/Toolchains/Hikari_LLVM19.0.0git.xctoolchain)
          TARGET_TOOLCHAIN_DIR=$(ls -d Build/install/Toolchains/*.xctoolchain | head -n 1)
          echo "âœ… å·¥å…·é“¾æ ¹ç›®å½•: $TARGET_TOOLCHAIN_DIR"
          
          # 3. å®šä½ Clang ç‰ˆæœ¬ç›®å½• (æ ¹æ®ä½ çš„æ—¥å¿—æ˜¯ .../usr/lib/clang/19)
          # æˆ‘ä»¬ä½¿ç”¨é€šé…ç¬¦åŒ¹é…é‚£ä¸ª '19' æ–‡ä»¶å¤¹
          CLANG_VER_DIR=$(ls -d $TARGET_TOOLCHAIN_DIR/usr/lib/clang/* | head -n 1)
          echo "âœ… Clangç‰ˆæœ¬ç›®å½•: $CLANG_VER_DIR"
          
          # 4. æ‰‹åŠ¨åˆ›å»ºç¼ºå¤±çš„ lib/darwin æ–‡ä»¶å¤¹
          TARGET_DIR="$CLANG_VER_DIR/lib/darwin"
          echo "ğŸš€ å‡†å¤‡åˆ›å»ºå¹¶ä¿®å¤åˆ°: $TARGET_DIR"
          mkdir -p "$TARGET_DIR"
          
          # 5. æ‰§è¡Œå¤åˆ¶
          cp -R "$SYS_LIB_PATH/" "$TARGET_DIR/"
          
          # 6. éªŒè¯
          if [ -f "$TARGET_DIR/libclang_rt.ios.a" ] || [ -f "$TARGET_DIR/libclang_rt.osx.a" ]; then
            echo "ğŸ‰ compiler-rt ä¿®å¤æˆåŠŸï¼"
          else
            echo "âŒ ä¿®å¤éªŒè¯å¤±è´¥ï¼Œæ–‡ä»¶å¯èƒ½æœªæ­£ç¡®å¤åˆ¶"
            ls -R "$CLANG_VER_DIR"
            exit 1
          fi

      - name: 10. æ‰“åŒ…å¹¶ä¸Šä¼ 
        run: |
          FULL_PATH=$(ls -d Build/install/Toolchains/*.xctoolchain | head -n 1)
          BASE_DIR=$(dirname "$FULL_PATH")
          FOLDER_NAME=$(basename "$FULL_PATH")
          cd "$BASE_DIR"
          tar -czvf ../../Hikari-LLVM15-Xcode16.tar.gz "$FOLDER_NAME"

      - name: 11. ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          files: Hikari-LLVM15-Xcode16.tar.gz
          body: "Hikari-LLVM15 é¢„ç¼–è¯‘å·¥å…·é“¾ (åŒ…å«ä¿®å¤åçš„ compiler-rt åº“)"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
