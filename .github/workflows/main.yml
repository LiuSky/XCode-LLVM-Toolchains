name: ç¼–è¯‘ Hikari-LLVM15 å·¥å…·é“¾ (Xcode 16)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'å‘å¸ƒåˆ° Release çš„ç‰ˆæœ¬å· (å¦‚ v1.0)'
        required: true
        default: 'v1.0'

permissions:
  contents: write

jobs:
  build_toolchain:
    runs-on: macos-14

    steps:
      - name: 1. è®¾ç½® Git ç¼“å†²åŒº
        run: git config --global http.postBuffer 524288000

      - name: 2. å®‰è£…ç¼–è¯‘ä¾èµ–
        run: brew install ninja cmake

      - name: 3. åˆ‡æ¢ Xcode ç‰ˆæœ¬åˆ° 16.2
        run: |
          sudo xcode-select -s /Applications/Xcode_16.2.app/Contents/Developer
          xcodebuild -version

      - name: 4. å…‹éš†æºç  (Recursive)
        run: |
          git clone --recursive -b apple-arm64e-upstream-next https://github.com/LiuSky/Hikari-LLVM15.git

      # --- ç¼“å­˜åŠ é€Ÿï¼šåªè¦ç¼–è¯‘æˆåŠŸä¸€æ¬¡ï¼Œä¸‹æ¬¡æ— éœ€ç­‰å¾… 1 å°æ—¶ ---
      - name: 5. ç¼“å­˜ç¼–è¯‘ç»“æœ (Cache)
        id: cache-llvm
        uses: actions/cache@v4
        with:
          path: Build
          key: ${{ runner.os }}-llvm-build-v3

      - name: 6. æ‰§è¡Œ CMake é…ç½®
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          mkdir -p Build
          cd Build
          ABS_INSTALL_DIR=$(pwd)/install
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS=clang \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="$ABS_INSTALL_DIR" \
            ../Hikari-LLVM15/llvm

      - name: 7. å¼€å§‹ Ninja ç¼–è¯‘
        if: steps.cache-llvm.outputs.cache-hit != 'true'
        run: |
          cd Build
          ninja

      - name: 8. ç”Ÿæˆ Xcode å·¥å…·é“¾ç»“æ„
        run: |
          cd Build
          # æ‰§è¡Œå®‰è£…ï¼Œå°†ç¼–è¯‘å‡ºçš„æ–‡ä»¶æ”¾å…¥ install ç›®å½•
          ninja install
          # ç”Ÿæˆ .xctoolchain æ–‡ä»¶å¤¹
          ninja install-xcode-toolchain

      # --- å…³é”®ä¿®æ”¹ï¼šè·³è¿‡æ‰€æœ‰ä¿®å¤æ­¥éª¤ï¼Œç›´æ¥æ‰“åŒ… ---
      - name: 9. æ‰“åŒ…å·¥å…·é“¾æˆå“
        run: |
          # å¯»æ‰¾ç”Ÿæˆçš„ .xctoolchain æ–‡ä»¶å¤¹
          # å®ƒé€šå¸¸åœ¨ Build/install/Toolchains/ ä¸‹ï¼Œæˆ–è€…ç›´æ¥åœ¨ Build/install/ ä¸‹
          TOOLCHAIN_PATH=$(find Build/install -name "*.xctoolchain" -type d | head -n 1)
          
          if [ -z "$TOOLCHAIN_PATH" ]; then
            echo "âŒ é”™è¯¯ï¼šæœªæ‰¾åˆ°ç”Ÿæˆçš„å·¥å…·é“¾æ–‡ä»¶å¤¹"
            find Build/install -maxdepth 4
            exit 1
          fi
          
          BASE_DIR=$(dirname "$TOOLCHAIN_PATH")
          FOLDER_NAME=$(basename "$TOOLCHAIN_PATH")
          
          echo "âœ… æ‰¾åˆ°å·¥å…·é“¾: $FOLDER_NAME åœ¨ $BASE_DIR"
          
          # è¿›å…¥æ‰€åœ¨ç›®å½•å¹¶æ‰“åŒ…
          cd "$BASE_DIR"
          tar -czvf ../../../Hikari-LLVM15-Xcode16.tar.gz "$FOLDER_NAME"
          echo "ğŸ“¦ æ‰“åŒ…å®Œæˆ"

      - name: 10. ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          files: ./Hikari-LLVM15-Xcode16.tar.gz
          body: |
            Hikari-LLVM15 åŸå§‹ç¼–è¯‘æˆå“ (Xcode 16)
            - ä»…åŒ…å«ç¼–è¯‘å‡ºçš„åŸå§‹æ–‡ä»¶
            - æœªè¿›è¡Œä»»ä½•åç»­è¡¥ä¸å¤„ç†
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
