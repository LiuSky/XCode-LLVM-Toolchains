name: 编译 Hikari-LLVM15 工具链 (Xcode 16)

on:
  workflow_dispatch:
    inputs:
      tag_name:
        description: '发布到 Release 的版本号 (如 v1.0)'
        required: true
        default: 'v1.0'

permissions:
  contents: write

jobs:
  build_toolchain:
    runs-on: macos-14

    steps:
      - name: 1. 设置 Git 缓冲区
        run: git config --global http.postBuffer 524288000

      - name: 2. 安装编译依赖
        run: brew install ninja cmake

      # --- 步骤 3：直接使用你自己的仓库并修复子模块链接 ---
      - name: 3. 克隆源码并重定向子模块地址
        run: |
          # 1. 克隆你自己的主仓库 (LiuSky/Hikari-LLVM15)
          git clone -b apple-arm64e-upstream-next https://github.com/LiuSky/Hikari-LLVM15.git
          cd Hikari-LLVM15
          
          # 2. 检查并替换 .gitmodules 中的所有失效链接为 LiuSky 自己的链接
          # 这一步是为了防止你的主仓库里还留着 61bcdefg 的死链
          sed -i '' 's/61bcdefg/LiuSky/g' .gitmodules
          
          echo "--- 确认修改后的子模块配置 ---"
          cat .gitmodules
          
          # 3. 同步配置并递归更新子模块
          git submodule sync
          git submodule update --init --recursive

      - name: 4. 执行 CMake 配置
        run: |
          mkdir Build
          cd Build
          cmake -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DLLVM_ENABLE_PROJECTS=clang \
            -DLLVM_TARGETS_TO_BUILD="X86;ARM;AArch64" \
            -DLLVM_ENABLE_ZSTD=OFF \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DLLVM_CREATE_XCODE_TOOLCHAIN=ON \
            -DLLVM_INCLUDE_TESTS=OFF \
            -DLLVM_INCLUDE_EXAMPLES=OFF \
            -DLLVM_INCLUDE_UTILS=OFF \
            -DLLVM_INCLUDE_BENCHMARKS=OFF \
            -DLLVM_BUILD_TOOLS=OFF \
            -DLLVM_INSTALL_TOOLCHAIN_ONLY=ON \
            -DCMAKE_INSTALL_PREFIX="./install" \
            ../Hikari-LLVM15/llvm

      - name: 5. 开始 Ninja 编译
        run: |
          cd Build
          ninja

      - name: 6. 安装并生成 Xcode 工具链
        run: |
          cd Build
          ninja install-xcode-toolchain

      - name: 7. 修复并复制 compiler-rt 库
        run: |
          CURRENT_XCODE_PATH=$(xcode-select -p)
          SYS_LIB_PATH=$(ls -d $CURRENT_XCODE_PATH/Toolchains/XcodeDefault.xctoolchain/usr/lib/clang/*/lib/darwin | head -n 1)
          echo "系统编译器库源路径: $SYS_LIB_PATH"
          
          TARGET_TOOLCHAIN_DIR=$(ls -d Build/install/*.xctoolchain | head -n 1)
          echo "生成的工具链根目录: $TARGET_TOOLCHAIN_DIR"
          
          TARGET_CLANG_LIB_DIR=$(ls -d $TARGET_TOOLCHAIN_DIR/usr/lib/clang/*/lib | head -n 1)
          
          if [ -n "$TARGET_CLANG_LIB_DIR" ]; then
            mkdir -p "$TARGET_CLANG_LIB_DIR"
            cp -R "$SYS_LIB_PATH" "$TARGET_CLANG_LIB_DIR/"
            echo "✅ compiler-rt 修复成功"
          else
            echo "❌ 错误：无法定位工具链内部的 Clang lib 目录"
            exit 1
          fi

      - name: 8. 打包工具链 (Hikari-LLVM15-Xcode16.tar.gz)
        run: |
          cd Build/install
          TOOLCHAIN_NAME=$(ls -d *.xctoolchain)
          tar -czvf ../../Hikari-LLVM15-Xcode16.tar.gz "$TOOLCHAIN_NAME"

      - name: 9. 上传成品到 GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.tag_name }}
          files: Hikari-LLVM15-Xcode16.tar.gz
          body: |
            ### Hikari LLVM 15 预编译工具链 (适配 Xcode 16)
            - **架构**: arm64 (Apple Silicon)
            - **源码**: 基于 LiuSky/Hikari-LLVM15 自家仓库
            - **已修复**: 已自动补全 Xcode 16.2 的 compiler-rt 库
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
